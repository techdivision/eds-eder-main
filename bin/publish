#!/bin/bash

# configuration
PROJECT="eds-eder-main"
REPO_OWNER="techdivision"
BRANCH="main"

# add environment configuration
if [ -f .env ]; then
  source .env
else
  echo ".env file not found! Copy .env.dist to .env and configure accordingly."
  exit 1
fi

# fetch query index
QUERY_INDEX="https://$BRANCH--$PROJECT--$REPO_OWNER.aem.live/query-index.json"
TMP_QUERY_INDEX="/tmp/query-index.json"
curl -s "$QUERY_INDEX" -o "$TMP_QUERY_INDEX"

# check if the JSON file was fetched successfully
if [ ! -f "$TMP_QUERY_INDEX" ]; then
    echo "Failed to fetch query index JSON data."
    exit 1
fi

# extract paths from the JSON data and store them in an array
PATHS=()
while IFS= read -r line; do
  PATHS+=("$line")
done < <(jq -r '.data[].path' "$TMP_QUERY_INDEX")
if [ ${#PATHS[@]} -eq 0 ]; then
    echo "No paths found in query index."
    exit 1
fi

# preview and publish
PREVIEW_URL="https://admin.hlx.page/preview/$REPO_OWNER/$PROJECT/$BRANCH/*"
PUBLISH_URL="https://admin.hlx.page/publish/$REPO_OWNER/$PROJECT/$BRANCH/*"
JSON_PAYLOAD=$(jq -n --argjson PATHS "$(printf '%s\n' "${PATHS[@]}" | jq -R . | jq -s .)" '{
  "forceUpdate": true,
  "paths": $PATHS,
  "delete": false
}')

curl -i -X POST \
  -H "Content-Type: application/json" \
  -H "x-auth-token: $TOKEN" \
  -d "$JSON_PAYLOAD"  \
  --url "$PREVIEW_URL"

curl -i -X POST \
  -H "Content-Type: application/json" \
  -H "x-auth-token: $TOKEN" \
  -d "$JSON_PAYLOAD"  \
  --url "$PUBLISH_URL"
