#!/bin/bash

# configuration
PROJECT="eds-eder-gmbh"
REPO_OWNER="techdivision"
BRANCH="main"
USE_LOCAL_FILE=false
LOCAL_FILE_PATH="/tmp/query-index.json"

# add environment configuration
if [ -f .env ]; then
  source .env
else
  echo ".env file not found! Copy .env.dist to .env and configure accordingly."
  exit 1
fi

# fetch query index
if [ "$USE_LOCAL_FILE" = false ]; then
  QUERY_INDEX="https://$BRANCH--$PROJECT--$REPO_OWNER.aem.page/query-index.json"
  curl -s "$QUERY_INDEX" -o "$LOCAL_FILE_PATH"
fi

# check if the JSON file was fetched successfully
if [ ! -f "$LOCAL_FILE_PATH" ]; then
    echo "Failed to fetch query index JSON data."
    exit 1
fi

# extract paths from the JSON data and store them in an array
PATHS=()
while IFS= read -r line; do
  PATHS+=("$line")
done < <(jq -r '.data[].path' "$LOCAL_FILE_PATH")
if [ ${#PATHS[@]} -eq 0 ]; then
    echo "No paths found in query index."
    exit 1
fi

# preview and publish
PREVIEW_URL="https://admin.hlx.page/preview/$REPO_OWNER/$PROJECT/$BRANCH/*"
PUBLISH_URL="https://admin.hlx.page/live/$REPO_OWNER/$PROJECT/$BRANCH/*"
JSON_PAYLOAD=$(jq -n --argjson PATHS "$(printf '%s\n' "${PATHS[@]}" | jq -R . | jq -s .)" '{
  "forceUpdate": true,
  "paths": $PATHS,
  "delete": false
}')

curl -X POST \
  -H "Content-Type: application/json" \
  -H "x-auth-token: $TOKEN" \
  -d "$JSON_PAYLOAD"  \
  --url "$PREVIEW_URL"

curl -X POST \
  -H "Content-Type: application/json" \
  -H "x-auth-token: $TOKEN" \
  -d "$JSON_PAYLOAD"  \
  --url "$PUBLISH_URL"
